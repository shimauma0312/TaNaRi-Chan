name: Docker Development Environment Health Check
permissions:
  contents: read

on:
  pull_request:
    branches: [develop]
  workflow_dispatch:

jobs:
  docker-health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Dockerレイヤーキャッシュ
      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Docker containers
        run: |
          echo "Building Docker containers..."
          docker compose build --no-cache

      - name: Start Docker containers
        run: |
          echo "Starting Docker containers..."
          docker compose up -d

      - name: Wait for containers to be ready
        run: |
          echo "Waiting for containers to start..."
          echo "Waiting for database container..."
          timeout 120 bash -c 'until docker compose exec -T db pg_isready -U postgres; do sleep 2; done'

          echo "Waiting for app container..."
          timeout 180 bash -c 'until docker compose exec -T app sh -c "echo ok" 2>/dev/null; do sleep 3; done'

          echo "Waiting for npm install to complete..."
          timeout 300 bash -c 'until docker compose exec -T app sh -c "test -d node_modules" 2>/dev/null; do sleep 5; done'

          echo "Container status:"
          docker compose ps

      - name: Check app container health
        run: |
          echo "Checking app container health..."
          docker compose exec -T app sh -c '
            echo "Node version:" && node --version && 
            echo "NPM version:" && npm --version && 
            echo "Checking package installation..." && ls -la node_modules/ | head -5 && 
            echo "Checking if Next.js dev server is starting..." && 
            timeout 30 bash -c "until curl -f http://localhost:3000 2>/dev/null; do sleep 2; echo \"Waiting for app...\"; done" || echo "App startup check completed"
          '

      - name: Setup Prisma - Step 1: Generate Client
        run: |
          echo "Step 1: Generating Prisma client..."
          docker compose exec -T app sh -c "echo 'Generating Prisma client...' && npx prisma generate && echo 'Prisma client generated successfully!'"

      - name: Setup Prisma - Step 2: Database Connection Test
        run: |
          echo "Step 2: Testing database connection..."
          docker compose exec -T app sh -c 'echo "Testing database connection..." && npx prisma db execute --stdin <<< "SELECT 1;" && echo "Database connection confirmed!"'

      - name: Setup Prisma - Step 3: Apply Migrations
        run: |
          echo "Step 3: Applying database migrations..."
          docker compose exec -T app sh -c 'echo "Applying migrations..." && npx prisma migrate deploy && echo "Migrations applied successfully!"'

      - name: Setup Prisma - Step 4: Seed Database
        run: |
          echo "Step 4: Seeding database with initial data..."
          docker compose exec -T app sh -c 'echo "Seeding database..." && npx prisma db seed && echo "Database seeding completed successfully!"'

      - name: Verify Prisma Studio can start
        run: |
          echo "Verifying Prisma Studio..."
          docker compose exec -T app sh -c 'echo "Starting Prisma Studio in background..." && timeout 30 npx prisma studio --port 5555 --hostname 0.0.0.0 & STUDIO_PID=$! && sleep 10 && echo "Checking if Prisma Studio is accessible..." && curl -f http://localhost:5555 || echo "Prisma Studio check completed" && kill $STUDIO_PID 2>/dev/null || true && echo "Prisma Studio verification completed!"'

      - name: Run basic application tests
        run: |
          echo "Running basic application tests..."
          docker compose exec -T app sh -c "
            echo 'Checking if Next.js app can start...' &&
            # ビルド実行
            timeout 60 npm run build &&
            echo 'Build completed successfully!' &&
            echo 'Checking environment variables...' &&
            # 環境変数存在確認
            env | grep -E '^(DATABASE_URL|NODE_ENV)' || echo 'Environment check completed'
          "

      - name: Check container logs
        if: always()
        run: |
          echo "=== App Container Logs ==="
          docker compose logs app || true
          echo "=== DB Container Logs ==="
          docker compose logs db || true

      - name: Show container status
        if: always()
        run: |
          echo "=== Container Status ==="
          docker compose ps || true
          echo "=== Docker Images ==="
          docker images || true

      # リソースのクリーンアップ
      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up containers..."
          # コンテナ、ボリューム、orphanコンテナを削除
          docker compose down -v --remove-orphans || true
          # 未使用のDockerリソースを削除（ディスク容量節約）
          docker system prune -f || true
