name: Docker Development Environment Health Check
permissions:
  contents: read

on:
  pull_request:
    branches: [develop]
  workflow_dispatch:

jobs:
  docker-health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Dockerレイヤーキャッシュ
      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Docker containers
        run: |
          echo "Building Docker containers..."
          docker compose build --no-cache

      - name: Start Docker containers
        run: |
          echo "Starting Docker containers..."
          # バックグラウンドでコンテナを起動
          docker compose up -d

      - name: Wait for containers to be ready
        run: |
          echo "Waiting for containers to start..."
          # データベースコンテナの起動を待機（最大120秒）
          echo "Waiting for database container..."
          timeout 120 bash -c 'until docker compose exec -T db pg_isready -U postgres; do sleep 2; done'

          # アプリケーションコンテナの起動を待機（最大180秒）
          echo "Waiting for app container..."
          timeout 180 bash -c 'until docker compose exec -T app sh -c "echo ok" 2>/dev/null; do sleep 3; done'

          # npm install の完了を待機（最大300秒）
          echo "Waiting for npm install to complete..."
          timeout 300 bash -c 'until docker compose exec -T app sh -c "test -d node_modules" 2>/dev/null; do sleep 5; done'

          # コンテナの状態を表示
          echo "Container status:"
          docker compose ps

      - name: Check app container health
        run: |
          echo "Checking app container health..."
          # appコンテナ内でNode環境とアプリケーションの基本チェック
          docker compose exec -T app sh -c "
            echo 'Node version:' && node --version &&
            echo 'NPM version:' && npm --version &&
            echo 'Checking package installation...' &&
            ls -la node_modules/ | head -5 &&
            echo 'Checking if Next.js dev server is starting...' &&
            timeout 30 bash -c 'until curl -f http://localhost:3000 2>/dev/null; do sleep 2; echo \"Waiting for app...\"; done' || echo 'App startup check completed'
          "

      - name: Setup Prisma and verify database connection
        run: |
          echo "Setting up Prisma..."
          # appコンテナ内でPrismaセットアップを実行
          docker compose exec -T app sh -c "
            echo 'Generating Prisma client...' &&
            npx prisma generate &&
            echo 'Checking database connection...' &&
            npx prisma db push --force-reset &&
            echo 'Database setup completed successfully!'
          "

      - name: Run database migrations
        run: |
          echo "Running database migrations..."
          # マイグレーションファイルでデータベーススキーマを更新する
          docker compose exec -T app sh -c "
            echo 'Running migrations...' &&
            npx prisma migrate dev --name ci-test --skip-generate &&
            echo 'Migrations completed successfully!'
          "

      - name: Seed database
        run: |
          echo "Seeding database..."
          # 開発用データをデータベースに挿入
          docker compose exec -T app sh -c "
            echo 'Seeding database...' &&
            npx prisma db seed &&
            echo 'Database seeding completed successfully!'
          "

      - name: Verify Prisma Studio can start
        run: |
          echo "Verifying Prisma Studio..."
          # Prisma Studioが正常に起動できることを確認
          docker compose exec -T app sh -c "
            echo 'Starting Prisma Studio in background...' &&
            # バックグラウンドでPrisma Studioを30秒間起動
            timeout 30 npx prisma studio --port 5555 --hostname 0.0.0.0 &
            STUDIO_PID=\$! &&
            sleep 10 &&
            echo 'Checking if Prisma Studio is accessible...' &&
            # Studio UIへのアクセス可能性をチェック
            curl -f http://localhost:5555 || echo 'Prisma Studio check completed' &&
            # バックグラウンドプロセスを終了
            kill \$STUDIO_PID 2>/dev/null || true &&
            echo 'Prisma Studio verification completed!'
          "

      - name: Run basic application tests
        run: |
          echo "Running basic application tests..."
          # Next.jsアプリケーションのビルドと環境変数の確認
          docker compose exec -T app sh -c "
            echo 'Checking if Next.js app can start...' &&
            # プロダクションビルドを実行（60秒タイムアウト）
            timeout 60 npm run build &&
            echo 'Build completed successfully!' &&
            echo 'Checking environment variables...' &&
            # 重要な環境変数の存在確認
            env | grep -E '^(DATABASE_URL|NODE_ENV)' || echo 'Environment check completed'
          "

      - name: Check container logs
        if: always()
        run: |
          echo "=== App Container Logs ==="
          # アプリケーションコンテナのログを表示
          docker compose logs app || true
          echo "=== DB Container Logs ==="
          # データベースコンテナのログを表示
          docker compose logs db || true

      - name: Show container status
        if: always()
        run: |
          echo "=== Container Status ==="
          # 現在のコンテナ状態を表示
          docker compose ps || true
          echo "=== Docker Images ==="
          # 利用可能なDockerイメージ一覧を表示
          docker images || true

      # リソースのクリーンアップ
      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up containers..."
          # コンテナ、ボリューム、orphanコンテナを削除
          docker compose down -v --remove-orphans || true
          # 未使用のDockerリソースを削除（ディスク容量節約）
          docker system prune -f || true
