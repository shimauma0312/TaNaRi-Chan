name: å“è³ªãƒã‚§ãƒƒã‚¯çµ±åˆ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    # feature ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ develop ã¸ã® PR ã‚‚å«ã‚€
    types: [ opened, synchronize, reopened ]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    
    steps:
    # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    # Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: 'src/package-lock.json'
    
    # ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        cd src
        npm ci
    
    # TypeScript å‹ãƒã‚§ãƒƒã‚¯
    - name: TypeScript å‹ãƒã‚§ãƒƒã‚¯
      run: |
        cd src
        npx tsc --noEmit
    
    # ESLint ã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    - name: ESLint å®Ÿè¡Œ
      run: |
        cd src
        npm run lint
    
    # Jest ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆè©³ç´°ç‰ˆï¼‰
    - name: Jest ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        cd src
        npm run test -- --verbose --coverage --watchAll=false --passWithNoTests
    
    # ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«è¿½åŠ ï¼ˆPRæ™‚ã®ã¿ï¼‰
    - name: ãƒ†ã‚¹ãƒˆçµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = 'src/coverage/coverage-summary.json';
          
          if (fs.existsSync(path)) {
            const coverage = JSON.parse(fs.readFileSync(path, 'utf8'));
            const total = coverage.total;
            
            const comment = `
            ## ğŸ§ª ãƒ†ã‚¹ãƒˆçµæœãƒ¬ãƒãƒ¼ãƒˆ
            
            | é …ç›® | ã‚«ãƒãƒ¬ãƒƒã‚¸ |
            |------|-----------|
            | è¡Œ | ${total.lines.pct}% |
            | é–¢æ•° | ${total.functions.pct}% |
            | åˆ†å² | ${total.branches.pct}% |
            | æ–‡ | ${total.statements.pct}% |
            
            ${total.lines.pct >= 80 ? 'âœ…' : 'âš ï¸'} ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: ${total.lines.pct}%
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }
    
    # å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å‡ºåŠ›
    - name: å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹å‡ºåŠ›
      run: |
        echo "ğŸ“Š å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†ï¼"
        echo "ğŸ§ª ãƒ†ã‚¹ãƒˆ: å®Ÿè¡Œæ¸ˆã¿"
        echo "ğŸ” å‹ãƒã‚§ãƒƒã‚¯: å®Œäº†"
        echo "âœ¨ ESLint: æ¤œè¨¼æ¸ˆã¿"
