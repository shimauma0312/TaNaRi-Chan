name: 品質チェック統合

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    # feature ブランチから develop への PR も含む
    types: [ opened, synchronize, reopened ]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    
    steps:
    # リポジトリをチェックアウト
    - name: リポジトリをチェックアウト
      uses: actions/checkout@v4
    
    # Node.js をセットアップ
    - name: Node.js をセットアップ
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: 'src/package-lock.json'
    
    # 依存関係をインストール
    - name: 依存関係をインストール
      run: |
        cd src
        npm ci
    
    # TypeScript 型チェック
    - name: TypeScript 型チェック
      run: |
        cd src
        npx tsc --noEmit
    
    # ESLint によるコード品質チェック
    - name: ESLint 実行
      run: |
        cd src
        npm run lint
    
    # Jest テスト実行（詳細版）
    - name: Jest テスト実行
      run: |
        cd src
        npm run test -- --verbose --coverage --watchAll=false --passWithNoTests
    
    # テスト結果をコメントに追加（PR時のみ）
    - name: テスト結果をPRにコメント
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = 'src/coverage/coverage-summary.json';
          
          if (fs.existsSync(path)) {
            const coverage = JSON.parse(fs.readFileSync(path, 'utf8'));
            const total = coverage.total;
            
            const comment = `
            ## 🧪 テスト結果レポート
            
            | 項目 | カバレッジ |
            |------|-----------|
            | 行 | ${total.lines.pct}% |
            | 関数 | ${total.functions.pct}% |
            | 分岐 | ${total.branches.pct}% |
            | 文 | ${total.statements.pct}% |
            
            ${total.lines.pct >= 80 ? '✅' : '⚠️'} テストカバレッジ: ${total.lines.pct}%
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }
    
    # 品質メトリクスを出力
    - name: 品質メトリクス出力
      run: |
        echo "📊 品質チェック完了！"
        echo "🧪 テスト: 実行済み"
        echo "🔍 型チェック: 完了"
        echo "✨ ESLint: 検証済み"
